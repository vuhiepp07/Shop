@using Shop

<div class="content">
    <div class="ProductInfo grid">
        <div>
            <img class="ProductInfo__img" src="/images/products/@ViewBag.MainProduct.ImageUrl" alt="Product Image">
        </div>
        <div class="ProductInfo__detail">
            <div class="ProductInfo__detail-name">
                <h3 class="ProductInfo__detail-heading">Tên sản phẩm </h3>
                @ViewBag.MainProduct.ProductName
            </div>
            <div class="ProductInfo__detail-description">
                <h3 class="ProductInfo__detail-heading">Mô tả</h3>
                @ViewBag.MainProduct.Description
            </div>

            @if(ViewBag.MainProduct.Price != ViewBag.MainProduct.DiscountPrice){
                float discountPercent = (ViewBag.MainProduct.Price - ViewBag.MainProduct.DiscountPrice) / (ViewBag.MainProduct.Price/100);
                <h3 class="ProductInfo__detail-heading">Khuyến mãi: @discountPercent%</h3>
            }
            <div class="ProductInfo__detail-price">
            <h3 class="ProductInfo__detail-heading">Giá sản phẩm: </h3>
                <div class="ProductInfo__detail-priceNew">
                    @Shop.Helper.normalizePrice(ViewBag.MainProduct.DiscountPrice.ToString())₫
                </div>
                @if(ViewBag.MainProduct.Price != ViewBag.MainProduct.DiscountPrice){
                    <div class="ProductInfo__detail-priceOld">
                        @Shop.Helper.normalizePrice(ViewBag.MainProduct.Price.ToString())₫
                    </div>
                }
            </div>
            <div class="ProductInfo__AddToCart">
                <div class="ProductInfo__AddToCartbtn">
                    Thêm vào giỏ hàng
                </div>
            </div>
        </div>
    </div>
    <div class="SameProductHeader">------ CÁC SẢN PHẨM TƯƠNG TỰ -----</div>
    <div class="grid">
        <div class="grid__full-width">
            <div class="grid__row">
                
            </div>
            <div class="pagination">
                <div class="pagination__loadMoreBtn">Tải thêm</div>
            </div>
        </div>
    </div>
</div>

<script>
    var productInSameCategoryField = document.querySelector('.grid__row') 
    var loadMoreBtn = document.querySelector('.pagination__loadMoreBtn')
    var productList = @Html.Raw(Json.Serialize(@ViewBag.Products))
    var page = 1
    console.log(productList)

    function normalizePrice(price){
        for(var i = price.length -1, x = 0 ; i> 0; i--, x++){
            if(x == 2){
                price = price.slice(0, i) + "," + price.slice(i)
                i++;
                x=-2;
            }
        }
        return price;
    }

    function LoadProductInSameCategory(){
        for(let i = (page - 1)*10, h = 0; h <10; h++,i++){
            console.log(i)
            let productPrice = String(productList[i]['price'])
            let productPriceInString = normalizePrice(productPrice)
            let productDiscountPrice = String(productList[i]['discountPrice'])
            let productDiscountPriceInString = normalizePrice(productDiscountPrice)

            let newHtml = `
                <div class="grid__column-TwoOfTen productList__item">
                    <div class="productList__item-img" style="background-image: url(/images/products/${productList[i]['imageUrl']});">
                        <div class="productList__item-addToCartbtn">
                            <input class="hiddenProductId" type="hidden" value=${productList[i]['productId']}>
                            Add to cart
                        </div>
                    </div>
                    <div class="productList__item-name">
                        <span>${productList[i]['productName']}</span>
                    </div>
                    
                    <div class="productList__item-Price">
            `
            if(productPrice != productDiscountPrice && productDiscountPrice != 0){
                newHtml += `
                <div class="productList__item-Newprice">
                    <span>${productDiscountPriceInString}₫</span>
                </div>
                <div class="productList__item-Oldprice">
                    <span>${productPriceInString}₫</span>
                </div>
                `
            let productDiscountPercentage = ((productList[i]['price'] - productList[i]['discountPrice'])/productList[i]['price'])*100
            newHtml += `
                <div class="productList__item-SaleOf">
                    <span style="line-height: 20px;" >GIẢM</span><br>
                    <span>${productDiscountPercentage}%</span>
                </div>
            `
            }
            else{
                newHtml += `
                    <div class="productList__item-Newprice">
                        <span>${productPriceInString}₫</span>
                    </div>
                `
            }
            
            newHtml += `</div>`
            newHtml += `</div>`
            productInSameCategoryField.innerHTML += newHtml
            if(i == productList.length - 1){
                loadMoreBtn.remove()
                console.log("luc nay het i" + i)
                break
            }
        } 
    }

    LoadProductInSameCategory()

    @* Check if user is logged in or not, if not, make them login to continue proceed  *@
    function MakeUserLogin(){
        alert("Vui lòng đăng nhập để thêm sản phẩm vào giỏ hàng")
        var loginModal = document.querySelector('.login__modal')
        loginModal.classList.add('modal-active')
    }
    
    addtocartBtn = document.querySelector('.ProductInfo__AddToCartbtn')
    addtocartBtn.addEventListener('click', function(e){
        if(@Html.Raw(Json.Serialize(@User.Identity.IsAuthenticated)) == false){
            MakeUserLogin()
        }
        if(@Html.Raw(Json.Serialize(@User.Identity.IsAuthenticated)) == true){
            let productId = @Html.Raw(Json.Serialize(@ViewBag.MainProduct.ProductId))
            let request = new XMLHttpRequest();
            request.open("POST", `/cart/add/${productId}`, true)
            request.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    document.querySelector('.barWithSearch__cart-numofProd').textContent = this.responseText
                }
            }
            request.send()
        }
    })

    @* Handling when user click on LoadMore button  *@
    loadMoreBtn.addEventListener('click', function(e){
        page = page + 1
        LoadProductInSameCategory()
    })
</script>


